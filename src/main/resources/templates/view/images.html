<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Management - QR Vehicle System</title>
    <link rel="shortcut icon" th:href="@{/images/UoPcrest.jpg}">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        .selection-form {
            max-width: 900px;
            margin: 0 auto;
            padding: 25px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .selection-form .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .image-container {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .current-image-box {
            text-align: center;
            padding: 20px;
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 12px;
            min-width: 260px;
        }

        .current-image-box img {
            max-width: 250px;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #ddd;
            object-fit: cover;
        }

        .upload-box {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background: #e8f5e9;
            border: 2px dashed #4caf50;
            border-radius: 12px;
        }

        .id-card {
            width: 340px;
            height: 214px;
            position: relative;
            background: linear-gradient(135deg, #800020, #1a237e);
            border-radius: 10px;
            color: white;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }

        .id-card-back {
            background: linear-gradient(135deg, #1a237e, #800020);
        }

        .id-card .card-header-bar {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .id-card .card-header-bar img {
            width: 25px;
            height: 25px;
            border-radius: 50%;
        }

        .id-card .card-body {
            display: flex;
            padding: 8px 12px;
            gap: 12px;
        }

        .id-card .photo-frame {
            width: 75px;
            height: 95px;
            background: rgba(255, 255, 255, 0.2);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .id-card .photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .id-card .card-details {
            font-size: 0.55em;
            line-height: 1.5;
            flex: 1;
        }

        .id-card .card-details .name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .id-card .card-details .field-label {
            opacity: 0.7;
            font-size: 0.9em;
        }

        .id-card .expiry-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 12px;
            font-size: 0.55em;
            display: flex;
            justify-content: space-between;
        }

        .archived-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .archived-grid img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .selection-form .form-grid {
                grid-template-columns: 1fr;
            }

            .image-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/layout :: header}"></div>
    <div class="container">
        <div th:replace="~{fragments/layout :: alerts}"></div>

        <div class="selection-form">
            <h2 style="text-align:center; margin-bottom:20px;">Image Management</h2>

            <div class="form-grid">
                <div class="form-group">
                    <label for="categorySelect">Category</label>
                    <select id="categorySelect" class="form-control" required>
                        <option value="">-- Select Category --</option>
                        <option value="student" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'student')}"
                            th:disabled="${lockedPermanent}">Student</option>
                        <option value="permanent" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'permanent')}">Permanent Staff</option>
                        <option value="temporary" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'temporary')}"
                            th:disabled="${lockedPermanent}">Temporary Staff</option>
                        <option value="casual" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'casual')}"
                            th:disabled="${lockedPermanent}">Casual Staff</option>
                        <option value="contract" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'contract')}"
                            th:disabled="${lockedPermanent}">Contract Staff</option>
                        <option value="institute" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'institute')}"
                            th:disabled="${lockedPermanent}">Institute Staff</option>
                        <option value="visitor" th:selected="${category != null and #strings.equalsIgnoreCase(category, 'visitor')}"
                            th:disabled="${lockedPermanent}">Visitor</option>
                    </select>
                </div>

                <div class="form-group hidden" id="nonStudentGroup">
                    <label id="personSelectLabel" for="personSelect">Select Person</label>
                    <select id="personSelect" class="form-control">
                        <option value="">-- Select --</option>
                    </select>
                </div>

                <div class="form-group hidden" id="facultyGroup">
                    <label for="facultySelect">Faculty</label>
                    <select id="facultySelect" class="form-control">
                        <option value="">-- Select Faculty --</option>
                    </select>
                </div>

                <div class="form-group hidden" id="yearGroup">
                    <label for="yearSelect">Academic Year</label>
                    <select id="yearSelect" class="form-control">
                        <option value="">-- Select Year --</option>
                    </select>
                </div>

                <div class="form-group hidden" id="studentGroup">
                    <label for="regNoSelect">Registration No</label>
                    <select id="regNoSelect" class="form-control">
                        <option value="">-- Select Registration No --</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="detailSection" class="hidden" style="margin-top:20px;">
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:15px; padding:15px;">
                    <div>
                        <h3 id="personName" style="margin:0;">-</h3>
                        <span id="personTypeAndId" style="color:#666; display:block;">-</span>
                        <span id="personDesignation" style="display:block; color:#888;"></span>
                        <span id="personDepartment" style="display:block; color:#888;"></span>
                        <span id="personSalaryDate" style="display:block; color:#888;"></span>
                    </div>
                </div>
            </div>

            <div class="image-container">
                <div class="current-image-box">
                    <h4>Current Photo</h4>
                    <img id="currentImage" src="" alt="Profile" class="hidden">
                    <div id="noImageBox" style="padding:40px 0; color:#999;">
                        <p style="font-size:3em;">ðŸ“·</p>
                        <p>No photo uploaded</p>
                    </div>

                    <form id="deleteForm" th:action="@{/view/images/delete}" method="post" style="margin-top:10px;"
                        sec:authorize="hasRole('ADMIN')"
                        onsubmit="return confirm('Delete this image? Old image will NOT be archived.')">
                        <input type="hidden" name="category" id="deleteCategory">
                        <input type="hidden" name="id" id="deleteId">
                        <button type="submit" class="btn btn-danger" style="font-size:0.85em;">Delete</button>
                    </form>
                </div>

                <div class="upload-box" sec:authorize="hasRole('VIEWER')">
                    <h4>Upload New Photo</h4>
                    <p style="font-size:0.85em; color:#666; margin-bottom:12px;">
                        Uploading a new photo will archive the current one automatically.
                    </p>
                    <form th:action="@{/view/images/upload}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="category" id="uploadCategory">
                        <input type="hidden" name="id" id="uploadId">

                        <div class="form-group">
                            <label for="profileImageInput">Select Image</label>
                            <input id="profileImageInput" type="file" name="profile_image" class="form-control" accept="image/*" required>
                        </div>

                        <div id="imagePreview" style="margin:10px 0; display:none; text-align:center;">
                            <img id="previewImg" src="" alt="Preview"
                                style="max-width:200px; max-height:250px; border-radius:8px; border:2px solid #4caf50;">
                        </div>

                        <button type="submit" class="btn btn-success" style="width:100%;">Upload Image</button>
                    </form>
                </div>
            </div>

            <div id="idCardSection" class="card hidden" style="margin-top:20px;">
                <div class="card-header">
                    <h3 class="card-title">ID Card Preview</h3>
                </div>
                <div style="padding:20px; display:flex; gap:25px; flex-wrap:wrap; justify-content:center;">
                    <div>
                        <h4 style="text-align:center; margin-bottom:8px;">Front</h4>
                        <div class="id-card">
                            <div class="card-header-bar">
                                <img th:src="@{/images/UoPcrest.jpg}" alt="Logo">
                                <span>UNIVERSITY OF PERADENIYA</span>
                            </div>
                            <div class="card-body">
                                <div class="photo-frame">
                                    <img id="idCardPhoto" src="" alt="Profile" class="hidden">
                                    <div id="idCardNoPhoto"
                                        style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2em;">
                                        ðŸ‘¤
                                    </div>
                                </div>
                                <div class="card-details">
                                    <div class="name" id="idCardName">Full Name</div>
                                    <div><span class="field-label">Designation: </span><span id="idCardDesignation">â€”</span></div>
                                    <div><span class="field-label">Department: </span><span id="idCardDepartment">â€”</span></div>
                                    <div><span class="field-label">Emp No: </span><span id="idCardEmpNo">â€”</span></div>
                                    <div><span class="field-label">NIC: </span><span id="idCardNic">â€”</span></div>
                                </div>
                            </div>
                            <div class="expiry-bar">
                                <span id="idCardType">Type: â€”</span>
                                <span id="idCardExpiry">Expiry: â€”</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 style="text-align:center; margin-bottom:8px;">Back</h4>
                        <div class="id-card id-card-back">
                            <div class="card-header-bar">
                                <img th:src="@{/images/UoPcrest.jpg}" alt="Logo">
                                <span>UNIVERSITY OF PERADENIYA</span>
                            </div>
                            <div style="padding:15px; font-size:0.55em; line-height:1.6;">
                                <p style="font-weight:bold; margin-bottom:8px;">CONDITIONS OF USE</p>
                                <ol style="margin:0; padding-left:15px;">
                                    <li>This card is the property of the University of Peradeniya.</li>
                                    <li>The holder must present this card on demand.</li>
                                    <li>Loss of this card must be reported immediately.</li>
                                    <li>This card is not transferable.</li>
                                </ol>
                            </div>
                            <div class="expiry-bar">
                                <span>University of Peradeniya</span>
                                <span>Information Technology Center</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align:center; padding:0 20px 20px;">
                    <button onclick="window.print()" class="btn btn-primary">Print ID Card</button>
                </div>
            </div>

            <div id="archivedSection" class="card hidden" style="margin-top:20px;">
                <div class="card-header">
                    <h3 class="card-title">Archived Images</h3>
                </div>
                <div style="padding:15px;">
                    <p style="color:#666; font-size:0.9em; margin-bottom:10px;">Previous photos that were replaced:</p>
                    <div id="archivedGrid" class="archived-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/layout :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script th:inline="javascript">
        const initialCategory = /*[[${category != null ? #strings.toLowerCase(category) : ''}]]*/ '';
        const initialId = /*[[${id != null ? id : ''}]]*/ '';
        const lockedPermanent = /*[[${lockedPermanent != null ? lockedPermanent : false}]]*/ false;
        const contextPath = '/';

        const categoryLabels = {
            student: 'Student',
            permanent: 'Permanent Staff',
            temporary: 'Temporary Staff',
            casual: 'Casual Staff',
            contract: 'Contract Staff',
            institute: 'Institute Staff',
            visitor: 'Visitor'
        };

        $(document).ready(function () {
            initializeSelect2($('#categorySelect'));

            $('#categorySelect').on('change', function () {
                const category = ($(this).val() || '').toLowerCase();
                onCategoryChange(category);
            });

            $('#personSelect').on('change', function () {
                const selectedId = $(this).val();
                const category = ($('#categorySelect').val() || '').toLowerCase();
                if (selectedId && category) {
                    loadDetails(category, selectedId);
                }
            });

            $('#facultySelect').on('change', function () {
                const faculty = $(this).val();
                $('#yearGroup').addClass('hidden');
                $('#studentGroup').addClass('hidden');
                if (faculty) {
                    loadYears(faculty);
                }
            });

            $('#yearSelect').on('change', function () {
                const faculty = $('#facultySelect').val();
                const year = $(this).val();
                $('#studentGroup').addClass('hidden');
                if (faculty && year) {
                    loadStudents(faculty, year);
                }
            });

            $('#regNoSelect').on('change', function () {
                const selectedId = $(this).val();
                if (selectedId) {
                    loadDetails('student', selectedId);
                }
            });

            const fileInput = document.querySelector('input[name="profile_image"]');
            if (fileInput) {
                fileInput.addEventListener('change', function (e) {
                    const preview = document.getElementById('imagePreview');
                    const previewImg = document.getElementById('previewImg');
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (ev) {
                            previewImg.src = ev.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    } else {
                        preview.style.display = 'none';
                    }
                });
            }

            if (initialCategory) {
                $('#categorySelect').val(initialCategory).trigger('change');
            }
            if (initialCategory && initialId) {
                loadDetails(initialCategory, initialId, true);
            }
        });

        function initializeSelect2($element, placeholder = '-- Select --') {
            if ($element.hasClass('select2-hidden-accessible')) {
                $element.select2('destroy');
            }
            $element.select2({
                placeholder: placeholder,
                allowClear: true,
                width: '100%'
            });
        }

        function onCategoryChange(category) {
            if (lockedPermanent && category && category !== 'permanent') {
                $('#categorySelect').val('permanent').trigger('change.select2');
                category = 'permanent';
            }

            resetSelectionViews();
            clearDetail();

            if (!category) {
                return;
            }

            if (category === 'student') {
                $('#facultyGroup').removeClass('hidden');
                loadFaculties();
                return;
            }

            $('#personSelectLabel').text('Select ' + (categoryLabels[category] || 'Person'));
            $('#nonStudentGroup').removeClass('hidden');
            loadPersons(category);
        }

        function resetSelectionViews() {
            $('#nonStudentGroup, #facultyGroup, #yearGroup, #studentGroup').addClass('hidden');
            $('#personSelect').empty().append('<option value="">-- Select --</option>');
            $('#facultySelect').empty().append('<option value="">-- Select Faculty --</option>');
            $('#yearSelect').empty().append('<option value="">-- Select Year --</option>');
            $('#regNoSelect').empty().append('<option value="">-- Select Registration No --</option>');
        }

        function loadPersons(category) {
            const $select = $('#personSelect');
            $select.empty().append('<option value="">Loading...</option>');

            $.getJSON(contextPath + 'api/persons/list', { category: category })
                .done(function (data) {
                    $select.empty().append('<option value="">-- Search and select --</option>');
                    $.each(data, function (_, item) {
                        $select.append($('<option>').val(item.id).text(item.label));
                    });
                    initializeSelect2($select, '-- Search and select --');
                    if (initialCategory === category && initialId) {
                        $select.val(initialId).trigger('change.select2');
                    }
                })
                .fail(function () {
                    $select.empty().append('<option value="">Error loading data</option>');
                    initializeSelect2($select, '-- Search and select --');
                });
        }

        function loadFaculties() {
            const $select = $('#facultySelect');
            $select.empty().append('<option value="">Loading...</option>');

            $.getJSON(contextPath + 'api/students/faculties')
                .done(function (data) {
                    $select.empty().append('<option value="">-- Select Faculty --</option>');
                    $.each(data, function (_, faculty) {
                        $select.append($('<option>').val(faculty).text(faculty));
                    });
                    initializeSelect2($select, '-- Select Faculty --');
                })
                .fail(function () {
                    $select.empty().append('<option value="">Error loading faculties</option>');
                    initializeSelect2($select, '-- Select Faculty --');
                });
        }

        function loadYears(faculty) {
            const $select = $('#yearSelect');
            $('#yearGroup').removeClass('hidden');
            $select.empty().append('<option value="">Loading...</option>');

            $.getJSON(contextPath + 'api/students/years', { faculty: faculty })
                .done(function (data) {
                    $select.empty().append('<option value="">-- Select Year --</option>');
                    $.each(data, function (_, year) {
                        $select.append($('<option>').val(year).text(year));
                    });
                    initializeSelect2($select, '-- Select Year --');
                })
                .fail(function () {
                    $select.empty().append('<option value="">Error loading years</option>');
                    initializeSelect2($select, '-- Select Year --');
                });
        }

        function loadStudents(faculty, year) {
            const $select = $('#regNoSelect');
            $('#studentGroup').removeClass('hidden');
            $select.empty().append('<option value="">Loading...</option>');

            $.getJSON(contextPath + 'api/students/list', { faculty: faculty, year: year })
                .done(function (data) {
                    $select.empty().append('<option value="">-- Search and select --</option>');
                    $.each(data, function (_, item) {
                        $select.append($('<option>').val(item.id).text(item.label));
                    });
                    initializeSelect2($select, '-- Search and select --');
                    if (initialCategory === 'student' && initialId) {
                        $select.val(initialId).trigger('change.select2');
                    }
                })
                .fail(function () {
                    $select.empty().append('<option value="">Error loading students</option>');
                    initializeSelect2($select, '-- Search and select --');
                });
        }

        function loadDetails(category, id, skipSelectorUpdate = false) {
            $.getJSON(contextPath + 'view/images/detail', { category: category, id: id })
                .done(function (data) {
                    renderDetails(category, id, data);
                    if (!skipSelectorUpdate) {
                        syncSelectedValue(category, id);
                    }
                })
                .fail(function (xhr) {
                    const message = xhr.responseJSON && xhr.responseJSON.error
                        ? xhr.responseJSON.error
                        : 'Failed to load person details';
                    alert(message);
                });
        }

        function renderDetails(category, id, data) {
            $('#detailSection').removeClass('hidden');

            $('#personName').text(data.name || '-');
            $('#personTypeAndId').text((data.type || '-') + ' â€” ' + (data.id || id));
            $('#personDesignation').text(data.designation || '');
            $('#personDepartment').text(data.department || '');

            if (data.salaryDate) {
                $('#personSalaryDate').text('Last Salary Date: ' + data.salaryDate);
            } else {
                $('#personSalaryDate').text('');
            }

            $('#uploadCategory').val(category);
            $('#uploadId').val(id);
            $('#deleteCategory').val(category);
            $('#deleteId').val(id);

            if (data.imageUrl) {
                $('#currentImage').attr('src', data.imageUrl).removeClass('hidden');
                $('#noImageBox').addClass('hidden');
                $('#idCardPhoto').attr('src', data.imageUrl).removeClass('hidden');
                $('#idCardNoPhoto').addClass('hidden');
            } else {
                $('#currentImage').attr('src', '').addClass('hidden');
                $('#noImageBox').removeClass('hidden');
                $('#idCardPhoto').attr('src', '').addClass('hidden');
                $('#idCardNoPhoto').removeClass('hidden');
            }

            const showStaffCard = category !== 'student' && category !== 'visitor';
            if (showStaffCard) {
                $('#idCardSection').removeClass('hidden');
                $('#idCardName').text(data.name || '-');
                $('#idCardDesignation').text(data.designation || 'â€”');
                $('#idCardDepartment').text(data.department || 'â€”');
                $('#idCardEmpNo').text(data.id || id);
                $('#idCardNic').text(data.staffNic || data.nic || 'â€”');
                $('#idCardType').text('Type: ' + (data.staffEmployeeType || data.employeeType || 'â€”'));
                $('#idCardExpiry').text('Expiry: ' + (data.expiryDate || 'â€”'));
            } else {
                $('#idCardSection').addClass('hidden');
            }

            const archived = Array.isArray(data.archivedImages) ? data.archivedImages : [];
            if (archived.length > 0) {
                $('#archivedSection').removeClass('hidden');
                const html = archived.map(img =>
                    `<img src="/uploads/images/Old/${encodeURIComponent(img)}" alt="${img}" title="${img}" onclick="window.open(this.src, '_blank')">`
                ).join('');
                $('#archivedGrid').html(html);
            } else {
                $('#archivedSection').addClass('hidden');
                $('#archivedGrid').empty();
            }
        }

        function syncSelectedValue(category, id) {
            if (category === 'student') {
                $('#regNoSelect').val(id).trigger('change.select2');
            } else {
                $('#personSelect').val(id).trigger('change.select2');
            }
        }

        function clearDetail() {
            $('#detailSection').addClass('hidden');
            $('#archivedGrid').empty();
        }
    </script>
</body>

</html>
