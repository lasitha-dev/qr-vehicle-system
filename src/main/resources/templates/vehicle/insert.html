<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insert Vehicle - QR Vehicle System</title>
    <link rel="shortcut icon" th:href="@{/images/UoPcrest.jpg}">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container {
            width: 100% !important;
        }

        .select2-container--default .select2-selection--single {
            height: 42px;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }

        .cascade-group {
            margin-bottom: 15px;
        }

        .cascade-group label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        #personSelectionArea {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <div class="logo-section">
                <img th:src="@{/images/UoPcrest.jpg}" alt="Logo" class="logo">
                <h1>Insert / Modify Vehicle</h1>
            </div>
            <div class="header-actions">
                <a th:href="@{/dashboard}" class="btn btn-primary">‚¨Ö Dashboard</a>
                <a th:href="@{/logout}" class="btn btn-logout">Logout</a>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Alerts -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Category Selection -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Select Category</h2>
            </div>

            <div class="form-group">
                <label>Choose a Category:</label>
                <select id="categorySelect" class="form-control" required>
                    <option value="">-- Select --</option>
                    <option value="student" th:selected="${category == 'student'}">Student</option>
                    <option value="permanent" th:selected="${category == 'permanent'}">Permanent Staff</option>
                    <option value="temporary" th:selected="${category == 'temporary'}">Temporary Staff</option>
                    <option value="casual" th:selected="${category == 'casual'}">Casual Staff</option>
                    <option value="contract" th:selected="${category == 'contract'}">Contract Staff</option>
                    <option value="institute" th:selected="${category == 'institute'}">Institute Staff</option>
                    <option value="visitor" th:selected="${category == 'visitor'}">Visitor</option>
                </select>
            </div>

            <!-- Approval Status Filter (appears after category is selected) -->
            <div class="form-group" id="approvalMenuGroup" style="display: none;">
                <label>Approval Menu:</label>
                <select id="approvalStatusSelect" class="form-control">
                    <option value="">-- All --</option>
                    <option value="Pending" th:selected="${selectedStatus == 'Pending'}">Pending</option>
                    <option value="Approved" th:selected="${selectedStatus == 'Approved'}">Approved</option>
                    <option value="Rejected" th:selected="${selectedStatus == 'Rejected'}">Rejected</option>
                </select>
            </div>
        </div>

        <!-- Person Selection (dynamic dropdowns) -->
        <div class="card" id="personSelectionArea">
            <div class="card-header">
                <h2 class="card-title">Select <span id="categoryLabel">Person</span></h2>
            </div>

            <!-- Non-student: single searchable dropdown -->
            <div id="nonStudentSection" style="display: none;">
                <div class="form-group">
                    <label>Select Person:</label>
                    <select id="personSelect" class="form-control">
                        <option value="">-- Select --</option>
                    </select>
                </div>
            </div>

            <!-- Student: 3-step cascade -->
            <div id="studentSection" style="display: none;">
                <div class="cascade-group">
                    <label>Faculty:</label>
                    <select id="facultySelect" class="form-control">
                        <option value="">-- Select Faculty --</option>
                    </select>
                </div>

                <div class="cascade-group" id="yearGroup" style="display: none;">
                    <label>Academic Year:</label>
                    <select id="yearSelect" class="form-control">
                        <option value="">-- Select Year --</option>
                    </select>
                </div>

                <div class="cascade-group" id="regNoGroup" style="display: none;">
                    <label>Registration No:</label>
                    <select id="regNoSelect" class="form-control">
                        <option value="">-- Select Registration No --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Existing Vehicles (when person is selected) -->
        <div class="card section vehicle" th:if="${vehicles}">
            <h3 style="margin-bottom: 15px;">Existing Vehicles</h3>

            <ul style="list-style: none; padding: 0;" th:if="${not #lists.isEmpty(vehicles)}">
                <li th:each="v : ${vehicles}"
                    style="padding: 12px 15px; background: #fafafa; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f0ad4e;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <strong th:text="${v.vehicleTypeDisplay + ' ' + v.vehicleNo}">Vehicle No</strong>
                            <span th:if="${v.owner}"> (Owner: <span th:text="${v.owner}"></span>)</span>
                            <span class="badge" th:classappend="${v.approvalStatus == 'Approved' ? 'badge-success' : 
                                               (v.approvalStatus == 'Pending' ? 'badge-warning' : 'badge-danger')}"
                                th:text="${v.approvalStatus}">Status</span>
                            <br>
                            <small style="color: #666;">
                                <span th:if="${v.mobile}">üì± <span th:text="${v.mobile}"></span> | </span>
                                <span th:if="${v.email}">‚úâÔ∏è <span th:text="${v.email}"></span></span>
                            </small>
                            <br>
                            <small style="color: #888;">Added by <span th:text="${v.createdBy}"></span> on <span
                                    th:text="${v.createDate}"></span></small>
                            <!-- Matched PDF certificates (for students) -->
                            <div th:if="${vehicleCertMap != null and vehicleCertMap.containsKey(v.vehicleNo) and not #lists.isEmpty(vehicleCertMap.get(v.vehicleNo))}"
                                style="margin-top: 6px;">
                                <th:block th:each="cert : ${vehicleCertMap.get(v.vehicleNo)}">
                                    <a th:href="@{${certBasePath} + '/' + ${cert}}" target="_blank" style="display: inline-flex; align-items: center; gap: 4px; color: #800000;
                                              text-decoration: none; font-size: 12px; font-weight: 600;
                                              padding: 3px 8px; background: #fff5f5; border: 1px solid #e0c0c0;
                                              border-radius: 5px; margin-right: 5px; margin-top: 3px;
                                              transition: all 0.2s;"
                                        onmouseover="this.style.background='#800000';this.style.color='white';this.style.borderColor='#800000'"
                                        onmouseout="this.style.background='#fff5f5';this.style.color='#800000';this.style.borderColor='#e0c0c0'">
                                        üìÑ <span th:text="${cert}">certificate.pdf</span>
                                    </a>
                                </th:block>
                            </div>
                        </div>
                        <!-- Admin action buttons -->
                        <div style="display: flex; gap: 6px; margin-left: 10px; flex-shrink: 0;">
                            <button type="button" class="btn btn-primary btn-sm edit-vehicle-btn" title="Edit"
                                th:data-empid="${v.empId}" th:data-vehicleno="${v.vehicleNo}" th:data-owner="${v.owner}"
                                th:data-vehicletypeid="${v.vehicleType != null ? v.vehicleType.id : ''}"
                                th:data-mobile="${v.mobile}" th:data-email="${v.email}"
                                th:data-approvalstatus="${v.approvalStatus}"
                                style="padding: 4px 10px; font-size: 13px;">‚úèÔ∏è Edit</button>
                            <form th:action="@{/vehicle/delete}" method="post" style="margin: 0;"
                                onsubmit="return confirm('Are you sure you want to delete this vehicle?');">
                                <input type="hidden" name="category" th:value="${category}">
                                <input type="hidden" name="id" th:value="${selectedId}">
                                <input type="hidden" name="vehicleNo" th:value="${v.vehicleNo}">
                                <input type="hidden" name="status" th:value="${selectedStatus}">
                                <button type="submit" class="btn btn-danger btn-sm" title="Delete"
                                    style="padding: 4px 10px; font-size: 13px;">üóëÔ∏è Delete</button>
                            </form>
                        </div>
                    </div>
                </li>
            </ul>

            <p th:if="${#lists.isEmpty(vehicles)}">No vehicles added yet.</p>
        </div>

        <!-- Edit Vehicle Modal -->
        <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
             background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
            <div style="background:#fff; border-radius:12px; padding:30px; max-width:550px; width:90%;
                 max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); position:relative;">
                <button type="button" onclick="closeEditModal()" style="position:absolute; top:10px; right:15px; border:none; background:none;
                        font-size:22px; cursor:pointer; color:#888;">‚úï</button>
                <h3 style="margin-top:0; margin-bottom:20px; color:#2c3e50;">Edit Vehicle</h3>

                <form id="editForm" th:action="@{/vehicle/update}" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="category" th:value="${category}">
                    <input type="hidden" name="id" th:value="${selectedId}">
                    <input type="hidden" name="oldVehicleNo" id="editOldVehicleNo">
                    <input type="hidden" name="status" th:value="${selectedStatus}">

                    <div class="form-group">
                        <label>Vehicle No: <span style="color:red;">*</span></label>
                        <input type="text" name="vehicleNo" id="editVehicleNo" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>Vehicle Type:</label>
                        <select name="vehicleTypeId" id="editVehicleTypeId" class="form-control">
                            <option value="">-- No Change --</option>
                            <option th:each="vt : ${vehicleTypes}" th:value="${vt.id}" th:text="${vt.displayName}">
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Owner Name:</label>
                        <input type="text" name="owner" id="editOwner" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Mobile No:</label>
                        <input type="text" name="mobile" id="editMobile" class="form-control" pattern="\+?\d{7,15}"
                            title="Enter a valid phone number">
                    </div>

                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="email" id="editEmail" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Approval Status:</label>
                        <select name="approvalStatus" id="editApprovalStatus" class="form-control">
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Replace Certificate (optional):</label>
                        <input type="file" name="certificate" class="form-control" accept="application/pdf,image/*">
                    </div>

                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="background:#6c757d; color:#fff; border:none; padding:8px 18px;
                                border-radius:6px; cursor:pointer;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Vehicle Form (when person is selected) -->
        <div class="card section form" th:if="${selectedId}">
            <h3 style="margin-bottom: 20px;">Add New Vehicle</h3>

            <form th:action="@{/vehicle/add}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="category" th:value="${category}">
                <input type="hidden" name="id" th:value="${selectedId}">
                <input type="hidden" name="status" th:value="${selectedStatus}">

                <div class="form-group">
                    <label>Vehicle No: <span style="color: red;">*</span></label>
                    <input type="text" name="vehicleNo" class="form-control" placeholder="e.g., ABC-1234" required>
                </div>

                <div class="form-group">
                    <label>Vehicle Type: <span style="color: red;">*</span></label>
                    <select name="vehicleTypeId" class="form-control" required>
                        <option value="">-- Select Vehicle Type --</option>
                        <option th:each="vt : ${vehicleTypes}" th:value="${vt.id}" th:text="${vt.displayName}">Vehicle
                            Type</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Owner Name:</label>
                    <input type="text" name="owner" class="form-control" placeholder="Vehicle owner name">
                </div>

                <div class="form-group">
                    <label>Mobile No: <span style="color: red;">*</span></label>
                    <input type="text" name="mobile" class="form-control" placeholder="+94771234567" required
                        pattern="\+?\d{7,15}" title="Enter a valid phone number (7-15 digits, optional + prefix)">
                </div>

                <div class="form-group">
                    <label>Email Address: <span style="color: red;">*</span></label>
                    <input type="email" name="email" class="form-control" placeholder="example@mail.com" required>
                </div>

                <div class="form-group">
                    <label>Certificate (PDF/Image): <span style="color: red;">*</span></label>
                    <input type="file" name="certificate" class="form-control" accept="application/pdf,image/*"
                        required>
                </div>

                <button type="submit" class="btn btn-success">Add Vehicle</button>
            </form>
        </div>
    </div>

    <footer class="site-footer">
        COPYRIGHT 2025 | INFORMATION TECHNOLOGY CENTER | UNIVERSITY OF PERADENIYA
    </footer>

    <!-- jQuery + Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script th:inline="javascript">
        const contextPath = '/';
        const currentCategory = /*[[${category != null ? category : ''}]]*/ '';
        const currentId = /*[[${selectedId != null ? selectedId : ''}]]*/ '';
        const currentStatus = /*[[${selectedStatus != null ? selectedStatus : ''}]]*/ '';

        $(document).ready(function () {

            // ========== Category change handler ==========
            $('#categorySelect').on('change', function () {
                const category = $(this).val();

                // Hide everything first
                $('#personSelectionArea').hide();
                $('#nonStudentSection').hide();
                $('#studentSection').hide();
                $('#yearGroup').hide();
                $('#regNoGroup').hide();

                if (!category) {
                    $('#approvalMenuGroup').hide();
                    return;
                }

                // Show approval menu dropdown
                $('#approvalMenuGroup').show();

                // Update label
                const labels = {
                    'student': 'Student', 'permanent': 'Permanent Staff',
                    'temporary': 'Temporary Staff', 'casual': 'Casual Staff',
                    'contract': 'Contract Staff', 'institute': 'Institute Staff',
                    'visitor': 'Visitor'
                };
                $('#categoryLabel').text(labels[category] || 'Person');
                $('#personSelectionArea').show();

                const status = $('#approvalStatusSelect').val();
                if (category === 'student') {
                    $('#studentSection').show();
                    loadFaculties();
                } else {
                    $('#nonStudentSection').show();
                    loadPersons(category, status);
                }
            });

            // ========== Approval Status change handler ==========
            $('#approvalStatusSelect').on('change', function () {
                const category = $('#categorySelect').val();
                const status = $(this).val();
                if (!category) return;

                // Reset person selection areas
                $('#yearGroup').hide();
                $('#regNoGroup').hide();

                if (category === 'student') {
                    // Reset cascading dropdowns - only reload faculties, year/regNo will cascade
                    loadFaculties();
                } else {
                    loadPersons(category, status);
                }
            });

            // ========== Non-student: load person list ==========
            function loadPersons(category, status) {
                const $select = $('#personSelect');
                $select.empty().append('<option value="">Loading...</option>');

                // Destroy existing Select2 instance before re-initializing
                if ($select.hasClass('select2-hidden-accessible')) {
                    $select.select2('destroy');
                }

                var params = { category: category };
                if (status) {
                    params.status = status;
                }

                $.getJSON(contextPath + 'api/persons/list', params)
                    .done(function (data) {
                        $select.empty().append('<option value="">-- Select --</option>');
                        $.each(data, function (i, item) {
                            $select.append($('<option>').val(item.id).text(item.label));
                        });
                        $select.select2({
                            placeholder: '-- Search and select --',
                            allowClear: true,
                            width: '100%'
                        });
                    })
                    .fail(function () {
                        $select.empty().append('<option value="">Error loading data</option>');
                    });
            }

            // Person selected ‚Üí navigate
            $('#personSelect').on('change', function () {
                const id = $(this).val();
                const category = $('#categorySelect').val();
                const status = $('#approvalStatusSelect').val();
                if (id && category) {
                    var url = contextPath + 'vehicle/insert?category=' + encodeURIComponent(category) + '&id=' + encodeURIComponent(id);
                    if (status) {
                        url += '&status=' + encodeURIComponent(status);
                    }
                    window.location.href = url;
                }
            });

            // ========== Student cascading dropdowns ==========
            function loadFaculties() {
                const $select = $('#facultySelect');
                $select.empty().append('<option value="">Loading...</option>');

                if ($select.hasClass('select2-hidden-accessible')) {
                    $select.select2('destroy');
                }

                $.getJSON(contextPath + 'api/students/faculties')
                    .done(function (data) {
                        $select.empty().append('<option value="">-- Select Faculty --</option>');
                        $.each(data, function (i, fac) {
                            $select.append($('<option>').val(fac).text(fac));
                        });
                        $select.select2({
                            placeholder: '-- Select Faculty --',
                            allowClear: true,
                            width: '100%'
                        });
                    })
                    .fail(function () {
                        $select.empty().append('<option value="">Error loading faculties</option>');
                    });
            }

            // Faculty selected ‚Üí load years
            $('#facultySelect').on('change', function () {
                const faculty = $(this).val();
                $('#yearGroup').hide();
                $('#regNoGroup').hide();

                if (!faculty) return;

                const $yearSelect = $('#yearSelect');
                $yearSelect.empty().append('<option value="">Loading...</option>');
                $('#yearGroup').show();

                if ($yearSelect.hasClass('select2-hidden-accessible')) {
                    $yearSelect.select2('destroy');
                }

                $.getJSON(contextPath + 'api/students/years', { faculty: faculty })
                    .done(function (data) {
                        $yearSelect.empty().append('<option value="">-- Select Year --</option>');
                        $.each(data, function (i, yr) {
                            $yearSelect.append($('<option>').val(yr).text(yr));
                        });
                        $yearSelect.select2({
                            placeholder: '-- Select Year --',
                            allowClear: true,
                            width: '100%'
                        });
                    })
                    .fail(function () {
                        $yearSelect.empty().append('<option value="">Error loading years</option>');
                    });
            });

            // Year selected ‚Üí load registration numbers
            $('#yearSelect').on('change', function () {
                const faculty = $('#facultySelect').val();
                const year = $(this).val();
                $('#regNoGroup').hide();

                if (!faculty || !year) return;

                const $regNoSelect = $('#regNoSelect');
                $regNoSelect.empty().append('<option value="">Loading...</option>');
                $('#regNoGroup').show();

                if ($regNoSelect.hasClass('select2-hidden-accessible')) {
                    $regNoSelect.select2('destroy');
                }

                $.getJSON(contextPath + 'api/students/list', { faculty: faculty, year: year, status: $('#approvalStatusSelect').val() || '' })
                    .done(function (data) {
                        $regNoSelect.empty().append('<option value="">-- Select Registration No --</option>');
                        $.each(data, function (i, item) {
                            $regNoSelect.append($('<option>').val(item.id).text(item.label));
                        });
                        $regNoSelect.select2({
                            placeholder: '-- Search and select --',
                            allowClear: true,
                            width: '100%'
                        });
                    })
                    .fail(function () {
                        $regNoSelect.empty().append('<option value="">Error loading students</option>');
                    });
            });

            // Student selected ‚Üí navigate
            $('#regNoSelect').on('change', function () {
                const id = $(this).val();
                const status = $('#approvalStatusSelect').val();
                if (id) {
                    var url = contextPath + 'vehicle/insert?category=student&id=' + encodeURIComponent(id);
                    if (status) {
                        url += '&status=' + encodeURIComponent(status);
                    }
                    window.location.href = url;
                }
            });

            // ========== Restore state on page reload ==========
            if (currentCategory) {
                // Restore approval status first, then trigger category change
                if (currentStatus) {
                    $('#approvalStatusSelect').val(currentStatus);
                }
                $('#categorySelect').val(currentCategory).trigger('change');
            }
        });

        // ========== Edit Modal Functions ==========
        $(document).on('click', '.edit-vehicle-btn', function () {
            var $btn = $(this);
            var vehicleNo = $btn.data('vehicleno') || '';
            var owner = $btn.data('owner') || '';
            var vehicleTypeId = $btn.data('vehicletypeid') || '';
            var mobile = $btn.data('mobile') || '';
            var email = $btn.data('email') || '';
            var approvalStatus = $btn.data('approvalstatus') || 'Pending';

            document.getElementById('editOldVehicleNo').value = vehicleNo;
            document.getElementById('editVehicleNo').value = vehicleNo;
            document.getElementById('editOwner').value = owner;
            document.getElementById('editMobile').value = mobile;
            document.getElementById('editEmail').value = email;
            document.getElementById('editApprovalStatus').value = approvalStatus;

            var vtSelect = document.getElementById('editVehicleTypeId');
            vtSelect.value = vehicleTypeId ? String(vehicleTypeId) : '';

            document.getElementById('editModal').style.display = 'flex';
        });

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Close modal on Escape key or outside click
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeEditModal();
        });
        document.getElementById('editModal').addEventListener('click', function (e) {
            if (e.target === this) closeEditModal();
        });
    </script>
</body>

</html>